#!/usr/bin/env python3

import xml.etree.ElementTree as ET
import random
import argparse
import sys
from pathlib import Path
from difflib import get_close_matches

BASE_DIR = Path(__file__).resolve().parent
FILE_PATH = BASE_DIR / "bible.xml"

# Standard Bible book abbreviations mapping
# Format: 'Book Name': [list of accepted abbreviations]
BOOK_ABBREVIATIONS = {
    # Old Testament
    'Genesis': ['gen', 'gn', 'genesis'],
    'Exodus': ['ex', 'exo', 'exod', 'exodus'],
    'Leviticus': ['lev', 'lv', 'leviticus'],
    'Numbers': ['num', 'nm', 'numb', 'numbers'],
    'Deuteronomy': ['deut', 'dt', 'deu', 'deuteronomy'],
    'Joshua': ['josh', 'js', 'jos', 'joshua'],
    'Judges': ['judg', 'jud', 'jdg', 'judges'],
    'Ruth': ['ruth', 'rt', 'rut'],
    '1 Samuel': ['1sam', '1sm', '1samuel', '1 sam', '1 samuel'],
    '2 Samuel': ['2sam', '2sm', '2samuel', '2 sam', '2 samuel'],
    '1 Kings': ['1kgs', '1ki', '1kings', '1 kings', '1 kgs'],
    '2 Kings': ['2kgs', '2ki', '2kings', '2 kings', '2 kgs'],
    '1 Chronicles': ['1chr', '1ch', '1chronicles', '1 chronicles', '1 chr'],
    '2 Chronicles': ['2chr', '2ch', '2chronicles', '2 chronicles', '2 chr'],
    'Ezra': ['ezra', 'ezr'],
    'Nehemiah': ['neh', 'ne', 'nehemiah'],
    'Esther': ['esth', 'et', 'est', 'esther'],
    'Job': ['job'],
    'Psalms': ['ps', 'psa', 'psalm', 'psalms'],
    'Proverbs': ['prov', 'prv', 'pro', 'proverbs'],
    'Ecclesiastes': ['eccl', 'ec', 'ecc', 'ecclesiastes'],
    'Song of Solomon': ['song', 'so', 'sos', 'songofsolomon', 'song of solomon'],
    'Isaiah': ['isa', 'is', 'isaiah'],
    'Jeremiah': ['jer', 'jr', 'jeremiah'],
    'Lamentations': ['lam', 'lm', 'lamentations'],
    'Ezekiel': ['ezek', 'ez', 'eze', 'ezekiel'],
    'Daniel': ['dan', 'dn', 'daniel'],
    'Hosea': ['hos', 'ho', 'hosea'],
    'Joel': ['joel', 'jl', 'joe'],
    'Amos': ['amos', 'am'],
    'Obadiah': ['obad', 'ob', 'oba', 'obadiah'],
    'Jonah': ['jonah', 'jon'],
    'Micah': ['mic', 'mi', 'micah'],
    'Nahum': ['nah', 'na', 'nahum'],
    'Habakkuk': ['hab', 'hk', 'habakkuk'],
    'Zephaniah': ['zeph', 'zp', 'zep', 'zephaniah'],
    'Haggai': ['hag', 'hg', 'haggai'],
    'Zechariah': ['zech', 'zc', 'zec', 'zechariah'],
    'Malachi': ['mal', 'ml', 'malachi'],
    # New Testament
    'Matthew': ['matt', 'mt', 'mat', 'matthew'],
    'Mark': ['mark', 'mk', 'mar'],
    'Luke': ['luke', 'lk', 'luk'],
    'John': ['john', 'jo', 'joh', 'jn'],
    'Acts': ['acts', 'act', 'ac'],
    'Romans': ['rom', 'rm', 'romans'],
    '1 Corinthians': ['1cor', '1co', '1corinthians', '1 corinthians', '1 cor'],
    '2 Corinthians': ['2cor', '2co', '2corinthians', '2 corinthians', '2 cor'],
    'Galatians': ['gal', 'gl', 'galatians'],
    'Ephesians': ['eph', 'ephesians'],
    'Philippians': ['phil', 'ph', 'php', 'philippians'],
    'Colossians': ['col', 'cl', 'colossians'],
    '1 Thessalonians': ['1thess', '1ts', '1th', '1thessalonians', '1 thessalonians', '1 thess'],
    '2 Thessalonians': ['2thess', '2ts', '2th', '2thessalonians', '2 thessalonians', '2 thess'],
    '1 Timothy': ['1tim', '1tm', '1ti', '1timothy', '1 timothy', '1 tim'],
    '2 Timothy': ['2tim', '2tm', '2ti', '2timothy', '2 timothy', '2 tim'],
    'Titus': ['titus', 'tt', 'tit'],
    'Philemon': ['philem', 'phm', 'phlm', 'philemon'],
    'Hebrews': ['heb', 'hb', 'hebrews'],
    'James': ['james', 'jm', 'jas', 'jam'],
    '1 Peter': ['1pet', '1pe', '1pt', '1peter', '1 peter', '1 pet'],
    '2 Peter': ['2pet', '2pe', '2pt', '2peter', '2 peter', '2 pet'],
    '1 John': ['1john', '1jo', '1jn', '1 john'],
    '2 John': ['2john', '2jo', '2jn', '2 john'],
    '3 John': ['3john', '3jo', '3jn', '3 john'],
    'Jude': ['jude', 'jd'],
    'Revelation': ['rev', 're', 'revelation'],
}

# Create reverse mapping from abbreviation to book name
ABBREV_TO_BOOK = {}
for book, abbrevs in BOOK_ABBREVIATIONS.items():
    for abbrev in abbrevs:
        ABBREV_TO_BOOK[abbrev] = book

# Pre-computed list for fuzzy matching
ALL_BOOK_SEARCH_TERMS = list(ABBREV_TO_BOOK.keys()) + list(BOOK_ABBREVIATIONS.keys())

# Mapping from book name to shortest abbreviation
BOOK_TO_SHORT_ABBREV = {}
for book, abbrevs in BOOK_ABBREVIATIONS.items():
    BOOK_TO_SHORT_ABBREV[book] = min(abbrevs, key=len)

def normalize_book_name(book_input):
    """Normalize and find the full book name from user input."""
    if not book_input:
        return None
    
    # Normalize input: lowercase and remove spaces
    normalized = book_input.lower().strip().replace(' ', '')
    
    # Direct lookup in reverse mapping
    if normalized in ABBREV_TO_BOOK:
        return ABBREV_TO_BOOK[normalized]
    
    return None

def find_similar_books(book_input):
    """Find similar book names for suggestions."""
    # Normalize input
    normalized = book_input.lower().strip()
    
    # Get close matches
    matches = get_close_matches(normalized, ALL_BOOK_SEARCH_TERMS, n=1, cutoff=0.6)
    
    if matches:
        match = matches[0]
        # Check if it's an abbreviation
        if match in ABBREV_TO_BOOK:
            return ABBREV_TO_BOOK[match]
        # Otherwise it's already a book name
        return match
    
    return None

def get_verses(file_path, book_filter=None):
    """Get verses, optionally filtered by book."""
    tree = ET.parse(file_path)
    root = tree.getroot()

    verses = []
    for book in root.findall('b'):
        book_name = book.get('n')
        
        # Apply book filter if specified
        if book_filter and book_name != book_filter:
            continue
            
        for chapter in book.findall('c'):
            chapter_num = chapter.get('n')
            for verse in chapter.findall('v'):
                verse_num = verse.get('n')
                if verse.text:
                    verses.append(
                        (book_name, chapter_num, verse_num, verse.text.strip())
                    )
    
    return verses

def get_random_verse(file_path, book_filter=None):
    """Get a random verse, optionally from a specific book."""
    verses = get_verses(file_path, book_filter)
    
    if not verses:
        return None
    
    book, ch, v, text = random.choice(verses)
    return f"{book} {ch}:{v} â€” {text}"

def print_help():
    """Print help message with book names and abbreviations."""
    print("Bible CLI - Get random verses from the Bible")
    print("\nUsage:")
    print("  bible              Get a random verse from any book")
    print("  bible -b BOOK      Get a random verse from a specific book")
    print("  bible --book=BOOK  Get a random verse from a specific book")
    print("  bible -h           Show this help message")
    print("\nExamples:")
    print("  bible -b Genesis")
    print("  bible -b Gen")
    print("  bible --book=Psalms")
    print("  bible -b Ps")
    print("\nAvailable Books and Their Abbreviations:")
    print("\nOld Testament:")
    ot_books = [
        ('Genesis', 'Gen, Gn'),
        ('Exodus', 'Ex, Exo, Exod'),
        ('Leviticus', 'Lev, Lv'),
        ('Numbers', 'Num, Nm, Numb'),
        ('Deuteronomy', 'Deut, Dt, Deu'),
        ('Joshua', 'Josh, Js, Jos'),
        ('Judges', 'Judg, Jud, Jdg'),
        ('Ruth', 'Rt, Rut'),
        ('1 Samuel', '1Sam, 1Sm, 1 Sam'),
        ('2 Samuel', '2Sam, 2Sm, 2 Sam'),
        ('1 Kings', '1Kgs, 1Ki, 1 Kgs'),
        ('2 Kings', '2Kgs, 2Ki, 2 Kgs'),
        ('1 Chronicles', '1Chr, 1Ch, 1 Chr'),
        ('2 Chronicles', '2Chr, 2Ch, 2 Chr'),
        ('Ezra', 'Ezr'),
        ('Nehemiah', 'Neh, Ne'),
        ('Esther', 'Esth, Et, Est'),
        ('Job', 'Job'),
        ('Psalms', 'Ps, Psa, Psalm'),
        ('Proverbs', 'Prov, Prv, Pro'),
        ('Ecclesiastes', 'Eccl, Ec, Ecc'),
        ('Song of Solomon', 'Song, So, SoS'),
        ('Isaiah', 'Isa, Is'),
        ('Jeremiah', 'Jer, Jr'),
        ('Lamentations', 'Lam, Lm'),
        ('Ezekiel', 'Ezek, Ez, Eze'),
        ('Daniel', 'Dan, Dn'),
        ('Hosea', 'Hos, Ho'),
        ('Joel', 'Jl, Joe'),
        ('Amos', 'Am'),
        ('Obadiah', 'Obad, Ob, Oba'),
        ('Jonah', 'Jon'),
        ('Micah', 'Mic, Mi'),
        ('Nahum', 'Nah, Na'),
        ('Habakkuk', 'Hab, Hk'),
        ('Zephaniah', 'Zeph, Zp, Zep'),
        ('Haggai', 'Hag, Hg'),
        ('Zechariah', 'Zech, Zc, Zec'),
        ('Malachi', 'Mal, Ml'),
    ]
    
    for book, abbrev in ot_books:
        print(f"  {book:<20} ({abbrev})")
    
    print("\nNew Testament:")
    nt_books = [
        ('Matthew', 'Matt, Mt, Mat'),
        ('Mark', 'Mk, Mar'),
        ('Luke', 'Lk, Luk'),
        ('John', 'Jo, Joh, Jn'),
        ('Acts', 'Act, Ac'),
        ('Romans', 'Rom, Rm'),
        ('1 Corinthians', '1Cor, 1Co, 1 Cor'),
        ('2 Corinthians', '2Cor, 2Co, 2 Cor'),
        ('Galatians', 'Gal, Gl'),
        ('Ephesians', 'Eph'),
        ('Philippians', 'Phil, Ph, Php'),
        ('Colossians', 'Col, Cl'),
        ('1 Thessalonians', '1Thess, 1Ts, 1Th, 1 Thess'),
        ('2 Thessalonians', '2Thess, 2Ts, 2Th, 2 Thess'),
        ('1 Timothy', '1Tim, 1Tm, 1Ti, 1 Tim'),
        ('2 Timothy', '2Tim, 2Tm, 2Ti, 2 Tim'),
        ('Titus', 'Tt, Tit'),
        ('Philemon', 'Philem, Phm, Phlm'),
        ('Hebrews', 'Heb, Hb'),
        ('James', 'Jm, Jas, Jam'),
        ('1 Peter', '1Pet, 1Pe, 1Pt, 1 Pet'),
        ('2 Peter', '2Pet, 2Pe, 2Pt, 2 Pet'),
        ('1 John', '1Jo, 1Jn, 1 John'),
        ('2 John', '2Jo, 2Jn, 2 John'),
        ('3 John', '3Jo, 3Jn, 3 John'),
        ('Jude', 'Jd'),
        ('Revelation', 'Rev, Re'),
    ]
    
    for book, abbrev in nt_books:
        print(f"  {book:<20} ({abbrev})")

def main():
    parser = argparse.ArgumentParser(
        description='Bible CLI - Get random verses from the Bible',
        add_help=False  # We'll handle help ourselves
    )
    parser.add_argument('-b', '--book', type=str, help='Specify a book to get verses from')
    parser.add_argument('-h', '--help', action='store_true', help='Show help message')
    
    args = parser.parse_args()
    
    # Handle help
    if args.help:
        print_help()
        sys.exit(0)
    
    # Handle book filter
    book_filter = None
    if args.book:
        book_filter = normalize_book_name(args.book)
        
        if not book_filter:
            # Try to find similar books
            similar = find_similar_books(args.book)
            if similar:
                # Get the abbreviated form for the suggestion using pre-computed mapping
                short_form = BOOK_TO_SHORT_ABBREV.get(similar, similar)
                print(f"'{args.book}' book doesn't exist, did you mean '{similar}' ({short_form})?")
            else:
                print(f"'{args.book}' book is not present in the Bible.")
            sys.exit(1)
    
    # Get and display verse
    verse = get_random_verse(FILE_PATH, book_filter)
    
    if verse:
        print(verse)
    else:
        print(f"No verses found for the book: {book_filter}")
        sys.exit(1)

if __name__ == "__main__":
    main()
